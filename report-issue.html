<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report an Issue - KNUST VoIP System</title>
    <link rel="icon" type="image/png" href="Gemini favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <meta name="description" content="Report a VoIP issue to the KNUST UITS Help Desk.">
</head>

<body class="page-report-issue">

    <!-- Global Header -->
    <header class="site-header">
        <div class="header-inner">
            <a href="https://voip.knust.edu.gh/" class="logo-area">
                <img src="voip_logo_new.png" alt="KNUST VoIP Logo" class="logo-img">
            </a>
            <button class="menu-toggle" aria-label="Toggle navigation">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <nav class="nav-links">
                <a href="https://voip.knust.edu.gh/">Home</a>
                <a href="about.html">About KVS</a>
                <a href="report-issue.html" class="active">Report an Issue</a>
                <a href="#" onclick="openPrintModal(event)">Print</a>
                <a href="services.html">Our Services</a>
                <a href="resources.html">Resources</a>
                <a href="contact.html">Contact Us</a>
                <a href="feedback.html">Feedback</a>
            </nav>
            <a href="#" class="admin-area">
                admin
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </a>
        </div>
    </header>

    <div class="page-banner"></div>

    <main class="container">

        <div class="tabs-container fade-in">
            <button class="tab-btn active" onclick="switchTab('open-ticket')">Open a New Ticket</button>
            <button class="tab-btn" onclick="switchTab('check-status')">Check Ticket Status</button>
            <button class="tab-btn" onclick="switchTab('faqs')">View FAQs</button>
        </div>

        <!-- Section: Open Ticket -->
        <section id="open-ticket" class="ticket-container report-section active">
            <div class="ticket-header">
                <h2>Open a New Ticket</h2>
                <p>Please fill in the form below to open a new ticket.</p>
            </div>

            <form id="issueForm" onsubmit="handleTicketSubmission(event)">
                <div id="formMessage" class="form-message"></div>

                <div class="ticket-form-group">
                    <input type="email" id="email" class="ticket-input" placeholder=" " required>
                    <label class="ticket-label" for="email">Email Address</label>
                </div>

                <div class="ticket-form-group">
                    <input type="text" id="fullName" class="ticket-input" placeholder=" " required>
                    <label class="ticket-label" for="fullName">Full Name</label>
                </div>

                <div class="ticket-form-group">
                    <div class="ticket-row">
                        <div class="phone-wrapper ticket-form-group">
                            <input type="tel" id="phone" class="ticket-input" placeholder=" ">
                            <label class="ticket-label optional" for="phone">Phone Number</label>
                        </div>
                        <div class="ext-wrapper ticket-form-group">
                            <input type="text" id="ext" class="ticket-input" placeholder=" ">
                            <label class="ticket-label optional" for="ext">Ext</label>
                        </div>
                    </div>
                </div>

                <div class="ticket-form-group">
                    <div class="ticket-form-group">
                        <select id="topic" class="ticket-select" onchange="handleTopicChange()" required>
                            <option value="" disabled selected></option>
                            <option value="connectivity">Connection/Link Issue</option>
                            <option value="hardware">Hardware Fault (Handset/Cable)</option>
                            <option value="new_ext">New Extension Request</option>
                            <option value="move_ext">Extension Transfer/Move</option>
                            <option value="voicemail">Voicemail Setup/Reset</option>
                            <option value="garnet">Garnet/Teams App Support</option>
                            <option value="intl_access">International Access</option>
                            <option value="billing">Billing/Extension Query</option>
                            <option value="supplier">Quotation or Invoices Requests (Suppliers)</option>
                            <option value="directory">Directory Update</option>
                            <option value="other">Other</option>
                        </select>
                        <label class="ticket-label" for="topic">Help Topic</label>
                    </div>

                    <div id="otherTopicGroup" class="ticket-form-group other-topic-group">
                        <input type="text" id="otherTopic" class="ticket-input" placeholder=" ">
                        <label class="ticket-label" for="otherTopic">Please specify your topic</label>
                    </div>

                    <div class="ticket-actions">
                        <button type="submit" class="btn-ticket btn-create">Create Ticket</button>
                        <button type="reset" class="btn-ticket btn-reset">Reset</button>
                        <a href="about.html" class="btn-ticket btn-cancel">Cancel</a>
                    </div>
                </div>
            </form>

            <div id="successState" class="success-state-container" style="display: none;">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h2>Ticket Submitted!</h2>
                <div class="ticket-id-display">
                    <span>ID:</span>
                    <strong id="displayTicketId">KV1234</strong>
                    <button class="copy-btn" onclick="copyTicketId()" title="Copy ID">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <p>Keep this ID to check your status later.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn-ticket btn-create" onclick="resetForm()"
                        style="padding: 0.5rem 1.5rem; font-size: 0.9rem;">New Ticket</button>
                    <button class="btn-ticket btn-reset" onclick="switchTab('check-status')"
                        style="padding: 0.5rem 1.5rem; font-size: 0.9rem;">Check Status</button>
                </div>
            </div>
        </section>

        <!-- Section: Check Status -->
        <section id="check-status" class="ticket-container report-section status-checker">
            <div class="ticket-header">
                <h2>Check Ticket Status</h2>
                <p>Enter your Ticket ID or Email to check the status of your request.</p>
            </div>

            <form id="statusForm" onsubmit="handleStatusCheck(event)">
                <div class="ticket-form-group" style="text-align: left;">
                    <label class="ticket-label" for="statusId">Ticket ID or Email</label>
                    <input type="text" id="statusId" class="ticket-input" placeholder="e.g. #12345 or user@knust.edu.gh"
                        required>
                </div>

                <div class="ticket-actions">
                    <button type="submit" class="btn-ticket btn-create"
                        style="background: var(--primary-navy); color: white;">Check Status</button>
                </div>
            </form>

            <div id="statusResult" class="status-result">
                <!-- Result populated by JS -->
            </div>
        </section>

        <!-- Section: FAQs -->
        <section id="faqs" class="ticket-container report-section">
            <div class="ticket-header">
                <h2>Frequently Asked Questions</h2>
                <p>Quick solutions to common VoIP problems.</p>
            </div>

            <div class="faq-list">
                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">How do I request a new VoIP line?</button>
                    <div class="faq-answer">
                        <p>To request a new line, use the "Open a New Ticket" form above and select "New Extension
                            Request" as the help topic. You'll need to provide the physical location/office number and
                            HOD approval.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">What is the Garnet app and how do I use
                        it?</button>
                    <div class="faq-answer">
                        <p>The Garnet app (powered by Microsoft Teams) allows you to use your university extension on
                            your mobile device or laptop. Simply log in with your university credentials and search for
                            "Garnet" in the apps menu.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">How can I reset my voicemail
                        password?</button>
                    <div class="faq-answer">
                        <p>Dial *97 from your extension or submit a ticket under "Voicemail Setup/Reset". Default
                            passwords should be changed immediately for security.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">Can I make international calls?</button>
                    <div class="faq-answer">
                        <p>International dialing is restricted by default. If your role requires international access,
                            please submit a ticket under "International Access" with approval from your Dean or
                            Director.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">Where can I access the Main VoIP
                        Directory?</button>
                    <div class="faq-answer">
                        <p>The main university-wide VoIP directory can be accessed directly from the <a
                                href="https://voip.knust.edu.gh/"
                                style="color: var(--accent-orange); font-weight: 600;">Home Page</a>. It is searchable
                            by department, unit, or name, ensuring you have the most up-to-date extensions at your
                            fingertips.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">How do I print a specific Department or
                        Location directory?</button>
                    <div class="faq-answer">
                        <p>You can generate a custom printable directory by clicking the <strong>Print</strong> link in
                            the navigation menu. Simply enter the department or location name in the pop-up modal (e.g.,
                            "Engineering" or "Hospital") and click "Generate Print Directory" to create a clean,
                            printable PDF version.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">Where is the Key and Critical Areas print
                        directory?</button>
                    <div class="faq-answer">
                        <p>A specialized directory for critical locations (Emergency, Security, Management) is
                            maintained for priority access. To obtain a printed copy, search for "Critical Areas" in the
                            printable directory generator or visit the <a href="resources.html"
                                style="color: var(--accent-orange); font-weight: 600;">Resources</a> page for
                            downloadable PDFs.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">How do I access the Call & Contact Center
                        directory?</button>
                    <div class="faq-answer">
                        <p>The Contact Center directory includes direct support lines for UITS, NOID, and other central
                            support units. These are prominently listed on the <a href="contact.html"
                                style="color: var(--accent-orange); font-weight: 600;">Contact Us</a> page for quick
                            troubleshooting and support resolution.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">How do I get the Garnet directory print
                        out?</button>
                    <div class="faq-answer">
                        <p>The Garnet (Teams Phone) directory is synchronized with the main university system. You can
                            generate a printable version specifically for Garnet-enabled units by selecting the "Garnet"
                            filter in our digital print tool available via the navigation header.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">What is the Active Directory for Microsoft
                        365 Teams Phone System?</button>
                    <div class="faq-answer">
                        <p>Our VoIP system is integrated with the <strong>Microsoft 365 Active Directory</strong>. This
                            means you can search for colleagues by name directly within the Microsoft Teams interface.
                            All official university extensions are synced automatically, providing a seamless calling
                            experience across both hardware handsets and the Teams app.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question" onclick="toggleFaq(this)">Who do I contact for urgent faults?</button>
                    <div class="faq-answer">
                        <p>For urgent campus-wide network outages or critical hardware failure, please call the NOID
                            DIVISION at +233 50 912 2826 (Ext: 170130). For non-urgent issues, please use the "Open a
                            New Ticket" tab on this page.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer>
        <div class="container" style="padding: 0;">
            <p>Copyright &copy; 2017 - <span id="current-year"></span>. VOIP DIRECTORY</p>
        </div>
    </footer>

    <!-- Digital Print Modal -->
    <div id="printModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closePrintModal()">&times;</button>
            <div class="modal-header">
                <h2>Digital Print Directory</h2>
                <p>Enter a department or location to generate a printable directory.</p>
            </div>
            <div class="modal-form-group">
                <label class="modal-label" for="printLocation">Department / Location Name</label>
                <input type="text" id="printLocation" class="modal-input"
                    placeholder="e.g. Engineering, Administration..." onkeypress="handlePrintKeyPress(event)">
            </div>
            <div class="modal-suggestions" id="printSuggestions">
                <span class="suggestion-tag" onclick="setPrintLocation('Administration')">Administration</span>
                <span class="suggestion-tag" onclick="setPrintLocation('Engineering')">Engineering</span>
                <span class="suggestion-tag" onclick="setPrintLocation('Science')">Science</span>
                <span class="suggestion-tag" onclick="setPrintLocation('Health Sciences')">Health Sciences</span>
                <span class="suggestion-tag" onclick="setPrintLocation('Halls of Residence')">Halls</span>
            </div>
            <button class="modal-btn" onclick="generatePrintDirectory()">Generate Print Directory</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        function switchTab(tabId) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(tabId.split('-')[0]) ||
                    (tabId === 'open-ticket' && btn.innerText.includes('Open')) ||
                    (tabId === 'check-status' && btn.innerText.includes('Check')) ||
                    (tabId === 'faqs' && btn.innerText.includes('FAQs'))) {
                    btn.classList.add('active');
                }
            });

            // Special case for "Open" button labeling
            if (tabId === 'open-ticket') {
                // Logic handled in logic above now more robustly
            }

            // Update sections
            document.querySelectorAll('.report-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function toggleFaq(button) {
            const item = button.parentElement;
            item.classList.toggle('active');
        }

        function handleTopicChange() {
            const topic = document.getElementById('topic').value;
            const otherGroup = document.getElementById('otherTopicGroup');
            const otherInput = document.getElementById('otherTopic');

            if (topic === 'other') {
                otherGroup.style.display = 'block';
                otherInput.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/gn0cxdrssyssm';

        async function handleTicketSubmission(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const formMessage = document.getElementById('formMessage');
            const originalBtnText = submitBtn.innerText;

            // UI State: Loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
            formMessage.style.display = 'none';
            formMessage.className = 'form-message';

            const ticketId = 'KV' + Math.floor(1000 + Math.random() * 9000);
            const formData = {
                ticket_id: ticketId,
                email: document.getElementById('email').value,
                full_name: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                extension: document.getElementById('ext').value,
                topic: document.getElementById('topic').value,
                other_topic: document.getElementById('otherTopic').value,
                status: 'Pending',
                created_at: new Date().toISOString(),
                admin_response: ''
            };

            try {
                const response = await fetch(SHEETDB_API_URL, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: [formData] })
                });

                const result = await response.json();

                if (response.ok) {
                    // UI State: Success
                    document.getElementById('issueForm').style.display = 'none';
                    document.getElementById('successState').style.display = 'block';
                    document.getElementById('displayTicketId').innerText = ticketId;

                    // Smooth scroll to top of section
                    document.getElementById('open-ticket').scrollIntoView({ behavior: 'smooth' });
                } else {
                    // UI State: API Error
                    let errorMsg = 'Failed to submit ticket. ';
                    if (result.error === 'Bad data format') {
                        errorMsg += 'Please ensure the Google Sheet columns match the required fields: ticket_id, email, full_name, phone, extension, topic, other_topic, status, created_at, admin_response.';
                    } else {
                        errorMsg += result.error || 'Server error.';
                    }
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                formMessage.innerText = error.message.includes('fetch') ? 'Network error. Please check your connection.' : error.message;
                formMessage.classList.add('error');
                formMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
            }
        }

        function copyTicketId() {
            const ticketId = document.getElementById('displayTicketId').innerText;
            navigator.clipboard.writeText(ticketId).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalSvg = btn.innerHTML;
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => btn.innerHTML = originalSvg, 2000);
            });
        }

        function resetForm() {
            document.getElementById('issueForm').reset();
            document.getElementById('issueForm').style.display = 'block';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('formMessage').style.display = 'none';
            document.getElementById('otherTopicGroup').style.display = 'none';
        }

        async function handleStatusCheck(event) {
            event.preventDefault();
            const resultDiv = document.getElementById('statusResult');
            const statusId = document.getElementById('statusId').value.trim();
            const checkBtn = event.target.querySelector('button[type="submit"]');

            checkBtn.disabled = true;
            checkBtn.innerText = 'Checking...';
            resultDiv.style.display = 'none';

            try {
                // Search by ticket_id or email
                const query = statusId.startsWith('KV') ? `ticket_id=${statusId}` : `email=${statusId}`;
                const response = await fetch(`${SHEETDB_API_URL}/search?${query}`);

                if (!response.ok) throw new Error('Search failed');

                const results = await response.json();

                resultDiv.style.display = 'block';
                if (results.length > 0) {
                    const ticket = results[results.length - 1];
                    const statusClass = (ticket.status || "").toLowerCase() === 'pending' ? 'status-pending' : 'status-online';
                    const displayTopic = ticket.topic === 'other' ? (ticket.other_topic || 'Other') : ticket.topic;

                    let adminResponseHtml = '';
                    if (ticket.admin_response && ticket.admin_response.trim() !== '') {
                        adminResponseHtml = `
                            <div class="admin-response-box">
                                <div class="admin-response-header">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    Help Desk Response:
                                </div>
                                <div class="admin-response-body">${ticket.admin_response}</div>
                            </div>
                        `;
                    }

                    resultDiv.innerHTML = `
                        <div class="status-tag ${statusClass}">${ticket.status || 'Unknown'}</div>
                        <h3 style="color: var(--primary-navy); margin-bottom: 0.5rem;">Ticket: ${ticket.ticket_id}</h3>
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>Name:</strong> ${ticket.full_name}</p>
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>Email:</strong> ${ticket.email}</p>
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>Phone:</strong> ${ticket.phone}</p>
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>Extension:</strong> ${ticket.extension || 'N/A'}</p>
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);"><strong>Topic:</strong> ${displayTopic}</p>
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Last updated: ${ticket.created_at ? new Date(ticket.created_at).toLocaleString() : 'N/A'}</p>
                        <p style="color: var(--text-primary); margin-bottom: 1rem;">Our support team is currently handling your request.</p>
                        ${adminResponseHtml}
                    `;
                } else {
                    resultDiv.innerHTML = `<p style="color: #e11d48; padding: 1rem; background: #fff1f2; border-radius: 8px; border: 1px solid #fda4af;">No ticket found for: <strong>${statusId}</strong></p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p style="color: #e11d48; padding: 1rem; background: #fff1f2; border-radius: 8px; border: 1px solid #fda4af;">Error checking status. Please try again later.</p>`;
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerText = 'Check Status';
            }
        }
    </script>
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
        var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
        (function () {
            var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
            s1.async = true;
            s1.src = 'https://embed.tawk.to/698b6fb4fe29c61c34711694/1jh4aomt1';
            s1.charset = 'UTF-8';
            s1.setAttribute('crossorigin', '*');
            s0.parentNode.insertBefore(s1, s0);
        })();
    </script>
    <!--End of Tawk.to Script-->
</body>

</html>